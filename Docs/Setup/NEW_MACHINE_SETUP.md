# WhenAndWhere - New Machine Setup Guide

This guide walks you through setting up the project on a new development machine after cloning from Git.

---

## Prerequisites

Before starting, ensure you have:
- **Node.js 18+** installed ([download](https://nodejs.org/))
- **Git** installed
- Access to your existing **Convex** account (https://dashboard.convex.dev)
- Access to your existing **Clerk** account (https://dashboard.clerk.com)

---

## Step 1: Clone and Install Dependencies

```bash
# Clone the repository
git clone <your-repo-url>
cd WhenAndWhere

# Install dependencies
npm install
```

---

## Step 2: Convex Setup

You have two options here:

### Option A: Connect to Existing Convex Deployment (Recommended for shared data)

1. Run Convex dev command:
   ```bash
   npx convex dev
   ```

2. When prompted:
   - Select **"Log in"** (use your existing Convex account)
   - Choose **"Choose an existing project"**
   - Select your WhenAndWhere project from the list

3. This will create `.env.local` with:
   ```env
   CONVEX_DEPLOYMENT=dev:your-project-name
   NEXT_PUBLIC_CONVEX_URL=https://your-project-123.convex.cloud
   ```

### Option B: Create New Convex Deployment (Fresh start)

1. Run Convex dev command:
   ```bash
   npx convex dev
   ```

2. When prompted:
   - Select **"Log in"** or create a new account
   - Choose **"Create a new project"**
   - Name it (e.g., `whenandwhere-dev`)

3. This will create `.env.local` with the new deployment URLs

> ⚠️ **Note:** With Option B, you'll have a fresh empty database - no existing missions, teams, or users.

---

## Step 3: Clerk Setup

### Option A: Use Existing Clerk Application (Same auth system)

1. Go to your Clerk Dashboard: https://dashboard.clerk.com
2. Select your existing application
3. Navigate to **API Keys** in the sidebar
4. Copy your keys

5. Add these to your `.env.local`:
   ```env
   NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
   CLERK_SECRET_KEY=sk_test_...
   NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
   NEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up
   NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/dashboard
   NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/dashboard
   ```

### Option B: Create New Clerk Application (Fresh auth)

1. Go to https://dashboard.clerk.com and create a new application
2. Copy the keys from the new application
3. Add them to `.env.local` (same format as above)
4. Configure the JWT template (see Step 4)

---

## Step 4: Configure Clerk JWT Template for Convex

This step is **required** for Clerk and Convex to communicate.

1. Go to Clerk Dashboard → **JWT Templates** (under Configure)
2. Click **+ New Template**
3. Select **Convex** from the template list
4. Click **Create** / **Apply Changes**
5. Note the issuer domain shown (e.g., `https://your-app.clerk.accounts.dev`)

### Verify auth.config.ts

If using a **new** Clerk application, update `convex/auth.config.ts`:

```typescript
export default {
  providers: [
    {
      domain: "https://YOUR-CLERK-DOMAIN.clerk.accounts.dev",
      applicationID: "convex",
    },
  ],
};
```

If using your **existing** Clerk app, the file should already be correctly configured.

---

## Step 5: Set Up Convex Environment Variables

1. Go to Convex Dashboard: https://dashboard.convex.dev
2. Select your project
3. Navigate to **Settings** → **Environment Variables**
4. Ensure these are set:

| Variable Name | Value |
|--------------|-------|
| `CLERK_HOSTNAME` | `your-app.clerk.accounts.dev` (your Clerk domain without https://) |
| `CLERK_WEBHOOK_SECRET` | `whsec_...` (from Clerk webhook setup - see Step 6) |

---

## Step 6: Set Up Webhook (Optional but Recommended)

Webhooks sync Clerk users to Convex automatically.

1. Go to Clerk Dashboard → **Webhooks**
2. Click **+ Add Endpoint**
3. Configure:
   - **Endpoint URL**: `https://YOUR-CONVEX-PROJECT.convex.site/clerk-webhook`
     - ⚠️ Note: Use `.convex.site` (NOT `.convex.cloud`)
   - **Events**: Select `user.created`, `user.updated`, `user.deleted`
4. Click **Create**
5. Copy the **Signing Secret** (starts with `whsec_...`)
6. Add this to Convex Dashboard → Settings → Environment Variables as `CLERK_WEBHOOK_SECRET`

> **Note:** The app includes a fallback `UserSync` component that auto-syncs users even without webhooks.

---

## Step 7: Run the Application

Open **two terminals**:

### Terminal 1 - Convex Dev Server
```bash
npx convex dev
```
Leave this running. It watches for Convex function changes.

### Terminal 2 - Next.js Dev Server
```bash
npm run dev
```

Visit http://localhost:3000

---

## Complete .env.local Template

Your final `.env.local` should look like this:

```env
# Convex (auto-generated by npx convex dev)
CONVEX_DEPLOYMENT=dev:your-project-name
NEXT_PUBLIC_CONVEX_URL=https://your-project-123.convex.cloud

# Clerk
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
CLERK_SECRET_KEY=sk_test_...
NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
NEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up
NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/dashboard
NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/dashboard
```

---

## First-Time User Setup (New Deployment Only)

If you created a new Convex deployment:

1. Sign up for an account via the app
2. Go to Convex Dashboard → Data → `users` table
3. Find your user and change `role` to `"Admin"`
4. Refresh the app - you now have admin access
5. Create initial data:
   - **Missions**: Lion Habitat, Seal Pool, Panda Grove
   - **Teams**: Day/Night crews per mission
   - **Shift Definitions**: Day (06:00-18:00), Night (18:00-06:00)

---

## Troubleshooting

### "404 on authentication" or JWT Errors
- Ensure Clerk JWT Template for Convex is created
- Verify `convex/auth.config.ts` has the correct Clerk domain
- Redeploy Convex: `npx convex deploy`

### User Not Syncing to Database
- Check webhook is configured correctly
- Verify `CLERK_WEBHOOK_SECRET` is set in Convex
- The app has fallback sync - just sign in and it will auto-create your user

### Cookie Security Warnings
- Normal when running on a non-localhost IP (e.g., `10.0.0.x`)
- Will resolve in production with HTTPS

### "Missing environment variable" Errors
- Ensure `.env.local` exists with all required variables
- Restart the dev server after adding env vars

---

## Quick Reference Commands

```bash
# Install dependencies
npm install

# Start Convex dev server (keep running)
npx convex dev

# Start Next.js dev server
npm run dev

# Deploy Convex to production
npx convex deploy

# Build for production
npm run build
```

---

## Notes

- The `.env.local` file is **gitignored** - you must recreate it on each machine
- Convex deployment info is stored in your Convex account, not locally
- Using the same Convex project = shared data across machines
- Using different Convex projects = isolated data per machine

---

## Related Documentation

- [Clerk + Convex Integration Details](./CLERK_CONVEX_INTEGRATION.md) - Deep dive into auth setup
- [Build Doc](../Build%20Doc.md) - Core concepts and data model
- [Roadmap](../Epics/ROADMAP.md) - Development progress and epic tracking

